///////////////////////////////////////////////
//                                           //
//      DropRPG by DeraKOren 25.01.2012      //
//              Full Version                 //
//                                           //
///////////////////////////////////////////////
private ["_this","_addMag"];

_this setVariable ["OldWeapon","some weapon", false];

_addMag =	{
				private ["_sol","_result","_curwep","_oldwep","_magaz"];
				_sol    = _this;
				_result = false;
				_curwep = currentWeapon (_sol);
				_oldwep = (_sol) getVariable "OldWeapon";

					if (_curwep != _oldwep) then{
						if ((_curwep != _oldwep) && (_curwep == "M136" || _curwep == "RPG18" || _curwep == "BAF_NLAW_Launcher" )) then{
							_magaz = switch (_curwep) do{
								case "M136"             : {"M136"};
								case "RPG18"            : {"RPG18"};
								case "BAF_NLAW_Launcher": {"NLAW"};
								};
							_sol addMagazine _magaz;
							_oldwep = _curwep;
						};
						if ((_curwep != _oldwep) && (_oldwep == "M136" || _oldwep == "RPG18" || _oldwep == "BAF_NLAW_Launcher" )) then{
							_magaz = switch (_oldwep) do{
								case "M136"             : {"M136"};
								case "RPG18"            : {"RPG18"};
								case "BAF_NLAW_Launcher": {"NLAW"};
							};
							_sol removeMagazines _magaz;
							_oldwep = _curwep;
						};
					_sol setVariable ["OldWeapon",_oldwep, false];
					};
				_result
			};
_this addAction ["","","",6,true,true,"",format ["Call %1", _addMag]];
_this addeventhandler ["Fired", {

	private ["_this","_weapon","_type","_list","_teamkillbase","_ammo","_bomb","_sol","_pos","_dir","_d","_wep"];
	_weapon = _this select 1;		// ??????      MAAWS, SMAW
	_ammo   = _this select 4;
	_bomb   = _this select 6;

	//////////////////////////////
	//  ???????? ???????? ????
	//////////////////////////////
	if( _ammo == "PipeBomb") then{	//???????? ????????? ?????????? PipeBomb
		_sol = _this select 0;		//??????
		_teamkillbase = false;		//???? ?????????? ?? ???????
		_list = nearestObjects [_sol,["Warfare_HQ_base_unfolded","WarfareBBaseStructure","BTR90_HQ","LAV25_HQ"],30]; 	//?????? ?????? ? ??????????? ?????

			for "_i" from 0 to (count _list) do{
				if ((side _sol) == (side (_list select _i))) then{		//???????? ?????? ??????????? ????? ? ??????????? ?????????? ?????? (???? ?? ?? ???????)
					_teamkillbase = true;
				};
			};
		if (_teamkillbase) then {deleteVehicle _bomb;};		//??????? ?????
	};

	if( _ammo == "Mine" || _ammo == "MineE") then{
		_mines_arr = [_bomb, time];
		mines set [count mines, _mines_arr];
	};


	if (_weapon == "M136" || _weapon == "RPG18" || _weapon == "BAF_NLAW_Launcher") then{
		_sol = _this select 0;		// ???????????
		_pos = getPosATL (_sol);	// ??????? ???????
		_dir = direction (_sol);	// ??????????? ???????
		_dir = _dir + 90;			// ??????????? ??? ??????? ??? (?????? ?? ???????)
		_d = 0.7;					// ?????????? ??????? ??? (?? ??????? ???????)

		_sol removeWeapon _weapon;
		_wep = "WeaponHolder" createVehicle [(_pos select 0) + (sin _dir*_d),(_pos select 1) + (cos _dir*_d),_pos select 2];
		_wep setPosATL [(_pos select 0) + (sin _dir*_d),(_pos select 1) + (cos _dir*_d),_pos select 2];
		_wep setDir (_dir);
		_wep addWeaponCargoGlobal[_weapon,1];
		_wep setDammage 1;			// ?????? ??????????? ?????? 1 (??????????) ??? ???? ????? ?????? ???? ??????? ??? ?????

		[_wep]spawn {
				private ["_wep"];
				_wep = _this select 0;
				sleep 30;
				deleteVehicle _wep;
		};
	};
}];